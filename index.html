<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pregunt√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9139161293045858"
     crossorigin="anonymous"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #1e293b;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 2rem;
        }
        .container {
            max-width: 480px;
            width: 95%;
            background: #ffffff;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            border-radius: 1.5rem;
            padding: 1.5rem;
        }
        .letter-button {
            transition: all 0.1s;
            cursor: pointer;
            user-select: none;
        }
        .letter-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .slot-box {
            min-width: 32px;
            min-height: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-bottom: 3px solid #6366f1;
            margin: 0 2px;
            font-size: 1.5rem;
            font-weight: 700;
        }
        .slot-box.filled {
            color: #10b981;
        }
        .slot-box.incorrect {
            border-bottom-color: #ef4444;
        }
    </style>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>

<div class="container" id="app">
    <h1 class="text-3xl font-bold text-center mb-6 text-indigo-600">Trivia Maestr√≠a</h1>

    <div id="loading-screen" class="p-6 text-center">
        <p class="text-lg font-semibold text-indigo-500 mb-2">Cargando preguntas...</p>
        <div class="w-full bg-gray-200 rounded-full h-2">
            <div id="load-progress" class="bg-indigo-600 h-2 rounded-full transition-all" style="width: 0%"></div>
        </div>
    </div>

    <div id="main-content" class="hidden">
        <!-- MENU PRINCIPAL -->
        <div id="mode-selection" class="space-y-4">
            <h2 class="text-xl font-semibold mb-4 text-center">Selecciona tu Desaf√≠o</h2>
            
            <!-- Mostrar monedas y pistas en el men√∫ principal -->
            <div class="mb-4 p-3 bg-gradient-to-r from-yellow-50 to-green-50 rounded-xl border-2 border-yellow-300 flex justify-around items-center">
                <div class="text-center">
                    <p class="text-xs text-gray-600">Monedas</p>
                    <p class="text-2xl font-bold text-green-600">üí∞ <span id="menu-coins-display">0</span></p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-600">Pistas</p>
                    <p class="text-2xl font-bold text-yellow-600">üí° <span id="menu-hints-display">0</span></p>
                </div>
            </div>
            
            <button onclick="startGame('Racha')" class="w-full py-3 px-4 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-xl transition shadow-lg shadow-indigo-300/50">
                üî• Modo Racha 
            </button>
            <button onclick="startGame('Aventura')" class="w-full py-3 px-4 bg-purple-500 hover:bg-purple-600 text-white font-bold rounded-xl transition shadow-lg shadow-purple-300/50">
                üéÆ Modo Aventura 
            </button>
            <button onclick="showMultiplayer()" class="w-full py-3 px-4 bg-pink-500 hover:bg-pink-600 text-white font-bold rounded-xl transition shadow-lg shadow-pink-300/50">
                üë• Modo Multijugador
            </button>
            <button onclick="showShop()" class="w-full py-3 px-4 bg-yellow-500 hover:bg-yellow-600 text-white font-bold rounded-xl transition shadow-lg shadow-yellow-300/50">
                üõí Tienda
            </button>
        </div>

        <!-- PANTALLA DE JUEGO -->
        <div id="game-screen" class="hidden">
            <div class="mb-4 p-3 bg-gray-100 rounded-xl flex justify-between items-center text-sm font-semibold">
                <span class="text-gray-700">Modo: <span id="current-mode">N/A</span></span>
                <span id="score-display-racha" class="text-red-600 flex items-center hidden">Racha: <span id="streak-display">0</span></span>
                <span id="score-display-aventura" class="text-green-600 flex items-center">
                    üí∞ <span id="coins-display">0</span> | üí° <span id="hints-display">0</span>
                </span>
            </div>

            <div id="racha-timer" class="text-2xl font-extrabold text-center mb-4 p-2 rounded-lg bg-red-100 text-red-600 transition duration-300 hidden">
                Tiempo: 15s
            </div>

            <div class="relative mb-6 p-4 bg-indigo-50 rounded-xl shadow-inner border-l-4 border-indigo-400">
                <p id="question-text" class="text-lg font-medium text-center text-indigo-900"></p>
                <p id="question-value" class="text-xs text-gray-500 mt-2 text-right"></p>
                <button id="hint-button" onclick="showHint()" class="absolute top-2 right-2 p-2 rounded-full bg-yellow-400 hover:bg-yellow-500 text-white transition hidden">
                    üí°
                </button>
            </div>

            <div id="aventura-input-container" class="space-y-4 hidden">
                <div id="answer-slots" class="flex justify-center mb-6 overflow-x-auto p-2"></div>
                <div id="letter-buttons" class="flex flex-wrap justify-center gap-2 mb-6 p-2 bg-gray-50 rounded-lg shadow-inner"></div>
                <div class="flex space-x-2">
                    <button onclick="undoLastLetter()" class="flex-shrink-0 w-1/4 py-3 bg-gray-400 hover:bg-gray-500 text-white font-bold rounded-xl transition shadow-lg">
                        ‚Ü∂
                    </button>
                    <button id="aventura-check-button" onclick="checkAnswer()" class="flex-grow w-3/4 py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-xl transition shadow-lg shadow-green-300/50">
                        Verificar
                    </button>
                </div>
            </div>

            <div id="racha-input-container" class="space-y-4 hidden">
                <input type="text" id="racha-answer-input" placeholder="Escribe tu respuesta (MAY√öSCULAS)" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:outline-none text-center uppercase" onkeydown="handleRachaKeyPress(event)">
                <button id="racha-check-button" onclick="checkAnswer()" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-xl transition shadow-lg shadow-green-300/50">
                    Responder
                </button>
                <p id="racha-feedback" class="text-center mt-4 font-semibold hidden"></p>
            </div>

            <button onclick="showModeSelection()" class="w-full py-2 text-sm text-gray-600 hover:text-indigo-600 transition mt-4">
                ‚¨ÖÔ∏è Volver a Modos
            </button>
        </div>

        <!-- PANTALLA DE TIENDA -->
        <div id="shop-screen" class="hidden space-y-4">
            <h2 class="text-2xl font-bold mb-4 text-center text-yellow-600">üõí Tienda</h2>
            
            <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-4 rounded-xl border-2 border-yellow-300">
                <h3 class="text-lg font-bold mb-2">üí° Pistas</h3>
                <p class="text-sm text-gray-600 mb-3">Las pistas revelan la primera letra de la respuesta</p>
                <div class="space-y-2">
                    <button onclick="buyHints(1)" class="w-full py-2 bg-yellow-400 hover:bg-yellow-500 text-white font-bold rounded-lg transition">
                        Comprar 1 pista - 50 üí∞
                    </button>
                    <button onclick="buyHints(5)" class="w-full py-2 bg-yellow-500 hover:bg-yellow-600 text-white font-bold rounded-lg transition">
                        Comprar 5 pistas - 200 üí∞ (Ahorra 50)
                    </button>
                    <button onclick="buyHints(10)" class="w-full py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg transition">
                        Comprar 10 pistas - 350 üí∞ (Ahorra 150)
                    </button>
                </div>
            </div>

            <div class="bg-gradient-to-r from-blue-50 to-cyan-50 p-4 rounded-xl border-2 border-blue-300">
                <h3 class="text-lg font-bold mb-2">‚è∞ Tiempo Extra (Modo Racha)</h3>
                <p class="text-sm text-gray-600 mb-3">Aumenta tu tiempo l√≠mite hasta 30 segundos</p>
                <div class="mb-3">
                    <p class="text-sm">Tiempo actual: <span id="time-limit-display" class="font-bold text-blue-600">15s</span></p>
                </div>
                <div class="space-y-2">
                    <button onclick="buyTime(5)" class="w-full py-2 bg-blue-400 hover:bg-blue-500 text-white font-bold rounded-lg transition">
                        +5 segundos - 100 üí∞
                    </button>
                    <button onclick="buyTime(10)" class="w-full py-2 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-lg transition">
                        +10 segundos - 150 üí∞ (Ahorra 50)
                    </button>
                </div>
            </div>

            <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-xl border-2 border-green-300">
                <h3 class="text-lg font-bold mb-2">üì∫ Anuncios</h3>
                <p class="text-sm text-gray-600 mb-3">Mira un anuncio y gana monedas gratis</p>
                <button id="watch-ad-btn" onclick="watchAd()" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg transition">
                    Ver Anuncio - Ganar 30 üí∞
                </button>
                <p id="ad-cooldown" class="text-xs text-gray-500 mt-2 text-center hidden"></p>
            </div>

            <button onclick="showModeSelection()" class="w-full py-2 text-sm text-gray-600 hover:text-indigo-600 transition mt-4">
                ‚¨ÖÔ∏è Volver a Modos
            </button>
        </div>

        <!-- PANTALLA MULTIJUGADOR -->
        <div id="multiplayer-screen" class="hidden space-y-4">
            <!-- Lobby Principal -->
            <div id="multiplayer-lobby" class="space-y-4 hidden">
                <h2 class="text-2xl font-bold mb-4 text-center text-pink-600">üë• Multijugador</h2>
                
                <div class="space-y-3">
                    <button onclick="showCreateRoom()" class="w-full py-3 px-4 bg-pink-500 hover:bg-pink-600 text-white font-bold rounded-xl transition shadow-lg">
                        üÜï Crear Sala
                    </button>
                    <button onclick="showJoinRoom()" class="w-full py-3 px-4 bg-purple-500 hover:bg-purple-600 text-white font-bold rounded-xl transition shadow-lg">
                        üö™ Unirse a Sala
                    </button>
                    <button onclick="showLeaderboard()" class="w-full py-3 px-4 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-xl transition shadow-lg">
                        üèÜ Ver Clasificaci√≥n
                    </button>
                </div>

                <button onclick="showModeSelection()" class="w-full py-2 text-sm text-gray-600 hover:text-indigo-600 transition mt-4">
                    ‚¨ÖÔ∏è Volver a Modos
                </button>
            </div>

            <!-- Crear Sala -->
            <div id="create-room-screen" class="hidden space-y-4">
                <h2 class="text-2xl font-bold mb-4 text-center text-pink-600">Crear Sala</h2>
                
                <div class="bg-pink-50 p-4 rounded-xl border-2 border-pink-300 space-y-4">
                    <div>
                        <label class="block text-sm font-bold mb-2">Tu Nombre:</label>
                        <input type="text" id="create-player-name" placeholder="Ingresa tu nombre" class="w-full p-2 border-2 border-gray-300 rounded-lg" maxlength="20">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">Cantidad de Rondas (5-20):</label>
                        <input type="number" id="room-rounds" min="5" max="20" value="10" class="w-full p-2 border-2 border-gray-300 rounded-lg">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">M√°ximo de Jugadores (2-10):</label>
                        <input type="number" id="room-max-players" min="2" max="10" value="4" class="w-full p-2 border-2 border-gray-300 rounded-lg">
                    </div>
                    
                    <button onclick="createRoom()" class="w-full py-3 bg-pink-500 hover:bg-pink-600 text-white font-bold rounded-xl transition shadow-lg">
                        Crear Sala
                    </button>
                </div>

                <button onclick="backToMultiplayerLobby()" class="w-full py-2 text-sm text-gray-600 hover:text-indigo-600 transition">
                    ‚¨ÖÔ∏è Volver
                </button>
            </div>

            <!-- Unirse a Sala -->
            <div id="join-room-screen" class="hidden space-y-4">
                <h2 class="text-2xl font-bold mb-4 text-center text-pink-600">Unirse a Sala</h2>
                
                <div class="bg-purple-50 p-4 rounded-xl border-2 border-purple-300 space-y-4">
                    <div>
                        <label class="block text-sm font-bold mb-2">Tu Nombre:</label>
                        <input type="text" id="join-player-name" placeholder="Ingresa tu nombre" class="w-full p-2 border-2 border-gray-300 rounded-lg" maxlength="20">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">C√≥digo de Sala:</label>
                        <input type="text" id="room-code-input" placeholder="Ingresa el c√≥digo" class="w-full p-2 border-2 border-gray-300 rounded-lg uppercase" maxlength="6">
                    </div>
                    
                    <button onclick="joinRoom()" class="w-full py-3 bg-purple-500 hover:bg-purple-600 text-white font-bold rounded-xl transition shadow-lg">
                        Unirse
                    </button>
                </div>

                <div class="bg-indigo-50 p-4 rounded-xl border-2 border-indigo-300">
                    <h3 class="text-lg font-bold mb-3">Salas Disponibles</h3>
                    <div id="available-rooms" class="space-y-2">
                        <p class="text-center text-gray-500">Cargando...</p>
                    </div>
                </div>

                <button onclick="backToMultiplayerLobby()" class="w-full py-2 text-sm text-gray-600 hover:text-indigo-600 transition">
                    ‚¨ÖÔ∏è Volver
                </button>
            </div>

            <!-- Sala de Espera -->
            <div id="room-waiting-screen" class="hidden space-y-4">
                <h2 class="text-2xl font-bold mb-4 text-center text-pink-600">Sala de Espera</h2>
                
                <div class="bg-pink-50 p-4 rounded-xl border-2 border-pink-300">
                    <div class="text-center mb-4">
                        <p class="text-sm text-gray-600">C√≥digo de Sala</p>
                        <p class="text-3xl font-bold text-pink-600" id="room-code-display">------</p>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-sm font-bold mb-2">Configuraci√≥n:</p>
                        <p class="text-sm">Rondas: <span id="room-rounds-display" class="font-bold">0</span></p>
                        <p class="text-sm">Jugadores: <span id="room-players-count">0</span>/<span id="room-max-players-display">0</span></p>
                    </div>
                    
                    <div>
                        <p class="text-sm font-bold mb-2">Jugadores en la sala:</p>
                        <div id="room-players-list" class="space-y-1">
                        </div>
                    </div>
                </div>

                <button id="start-multiplayer-btn" onclick="startMultiplayerGame()" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-xl transition shadow-lg hidden">
                    Iniciar Partida
                </button>

                <button onclick="leaveRoom()" class="w-full py-2 text-sm text-red-600 hover:text-red-700 transition">
                    Salir de la Sala
                </button>
            </div>

            <!-- Clasificaci√≥n -->
            <div id="leaderboard-screen" class="hidden space-y-4">
                <h2 class="text-2xl font-bold mb-4 text-center text-pink-600">üèÜ Clasificaci√≥n Global</h2>
                
                <div class="bg-pink-50 p-4 rounded-xl border-2 border-pink-300">
                    <h3 class="text-lg font-bold mb-3">Top Jugadores</h3>
                    <div id="leaderboard-container" class="space-y-2">
                        <p class="text-center text-gray-500">Cargando...</p>
                    </div>
                </div>

                <div class="bg-indigo-50 p-4 rounded-xl border-2 border-indigo-300">
                    <h3 class="text-lg font-bold mb-3">Tu Perfil</h3>
                    <p class="text-sm mb-2">Nombre: <span id="player-name-display" class="font-bold">Jugador</span></p>
                    <p class="text-sm mb-2">Monedas: <span id="player-coins-display" class="font-bold text-green-600">0</span></p>
                    <input type="text" id="player-name-input" placeholder="Ingresa tu nombre" class="w-full p-2 border-2 border-gray-300 rounded-lg mb-2" maxlength="20">
                    <button onclick="updatePlayerName()" class="w-full py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-lg transition">
                        Actualizar Nombre
                    </button>
                </div>

                <button onclick="backToMultiplayerLobby()" class="w-full py-2 text-sm text-gray-600 hover:text-indigo-600 transition">
                    ‚¨ÖÔ∏è Volver
                </button>
            </div>

            <!-- Juego Multijugador -->
            <div id="multiplayer-game-screen" class="hidden">
                <div class="mb-4 p-3 bg-pink-100 rounded-xl text-sm font-semibold">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-700">Ronda: <span id="mp-round-display">1</span>/<span id="mp-total-rounds">10</span></span>
                        <span class="text-pink-600">Puntos: <span id="mp-score-display">0</span></span>
                    </div>
                    <div id="mp-timer" class="text-2xl font-extrabold text-center p-2 rounded-lg bg-red-100 text-red-600">
                        Tiempo: 15s
                    </div>
                </div>

                <div class="relative mb-6 p-4 bg-indigo-50 rounded-xl shadow-inner border-l-4 border-indigo-400">
                    <p id="mp-question-text" class="text-lg font-medium text-center text-indigo-900"></p>
                </div>

                <div class="space-y-4">
                    <input type="text" id="mp-answer-input" placeholder="Escribe tu respuesta (MAY√öSCULAS)" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:outline-none text-center uppercase" onkeydown="handleMultiplayerKeyPress(event)">
                    <button id="mp-check-button" onclick="submitMultiplayerAnswer()" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-xl transition shadow-lg shadow-green-300/50">
                        Responder
                    </button>
                    <p id="mp-feedback" class="text-center mt-4 font-semibold hidden"></p>
                </div>

                <div id="mp-waiting" class="hidden mt-4 p-4 bg-yellow-50 rounded-xl border-2 border-yellow-300 text-center">
                    <p class="font-bold text-yellow-700">Esperando a otros jugadores...</p>
                    <p class="text-sm text-gray-600 mt-2">Han respondido: <span id="mp-answered-count">0</span>/<span id="mp-total-players">0</span></p>
                </div>

                <div id="mp-scoreboard" class="hidden mt-4 p-4 bg-indigo-50 rounded-xl border-2 border-indigo-300">
                    <h3 class="text-lg font-bold mb-3 text-center">Puntuaciones</h3>
                    <div id="mp-scoreboard-list" class="space-y-1">
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL -->
        <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div id="modal-content" class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-sm text-center">
                <h3 id="modal-title" class="text-2xl font-bold mb-3">¬°T√≠tulo!</h3>
                <p id="modal-text" class="mb-5 text-gray-700"></p>
                <div id="modal-buttons" class="space-y-3"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let rachaQuestions = [];
    let adventureQuestions = [];

    const SHEET_ID = '1sk322HMzWsLTLb5VpI50qvP0u7n36gvNDFv8E9WOfAY';
    const RACHA_GID = '0';
    const AVENTURA_GID = '157464759';

    const TIME_LIMIT = 15;
    const MAX_TIME_LIMIT = 30;
    const MP_TIME_LIMIT = 15;

    // Configuraci√≥n de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyB400ygHxKjrlTblU_WgFMyxZw8WcvmWEE",
        authDomain: "trivia-maestra-db638.firebaseapp.com",
        databaseURL: "https://trivia-maestra-db638-default-rtdb.firebaseio.com",
        projectId: "trivia-maestra-db638",
        storageBucket: "trivia-maestra-db638.firebasestorage.app",
        messagingSenderId: "935977438176",
        appId: "1:935977438176:web:5730480f520ba511687985",
        measurementId: "G-W82LVG2L7H"
    };

    // Inicializar Firebase
    let database = null;
    try {
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        console.log('‚úÖ Firebase conectado');
    
        // üîç DIAGN√ìSTICO TEMPORAL - Probar conexi√≥n
        database.ref('.info/connected').on('value', (snapshot) => {
            if (snapshot.val() === true) {
                console.log('‚úÖ Firebase: Conexi√≥n activa');
            } else {
                console.log('‚ùå Firebase: Sin conexi√≥n');
            }
        });
    } catch (error) {
        console.error('‚ùå Error conectando Firebase:', error);
    }

    // Adaptador de almacenamiento que simula window.storage pero usa Firebase
    window.storage = {
        async set(key, value, shared = false) {
            if (!database) {
                console.error('‚ùå Firebase no disponible');
                throw new Error('Firebase no est√° conectado');
            }
            try {
                const path = shared ? `shared/${key}` : `users/${key}`;
                // ‚úÖ Si value es string que parece JSON, parsearlo primero
                const dataToSave = typeof value === 'string' && value.startsWith('{') 
                    ? JSON.parse(value) 
                    : value;
                await database.ref(path).set(dataToSave);
                console.log('‚úÖ Guardado:', path);
                return { key, value: dataToSave, shared };
            } catch (error) {
                console.error('‚ùå Error en set:', error);
                throw error;
            }
        },
    
        async get(key, shared = false) {
            if (!database) {
                console.error('‚ùå Firebase no disponible');
                throw new Error('Firebase no est√° conectado');
            }
            try {
                const path = shared ? `shared/${key}` : `users/${key}`;
                const snapshot = await database.ref(path).once('value');
                const value = snapshot.val();
                if (value === null) throw new Error('Key not found');
                console.log('‚úÖ Obtenido:', path);
                // ‚úÖ Firebase ya devuelve objetos, NO hacer JSON.parse
                return { key, value, shared };
            } catch (error) {
                console.error('‚ùå Error en get:', path, error.message);
                throw error;
            }
        },
    
        async delete(key, shared = false) {
            if (!database) {
                console.error('‚ùå Firebase no disponible');
                throw new Error('Firebase no est√° conectado');
            }
            try {
                const path = shared ? `shared/${key}` : `users/${key}`;
                await database.ref(path).remove();
                console.log('‚úÖ Eliminado:', path);
                return { key, deleted: true, shared };
            } catch (error) {
                console.error('‚ùå Error en delete:', error);
                throw error;
            }
        },
    
        async list(prefix = '', shared = false) {
            if (!database) {
                console.error('‚ùå Firebase no disponible');
                throw new Error('Firebase no est√° conectado');
            }
            try {
                const path = shared ? `shared` : `users`;
                const snapshot = await database.ref(path).once('value');
                const data = snapshot.val();
                if (!data) return { keys: [], prefix, shared };
            
                const keys = Object.keys(data).filter(key => 
                    !prefix || key.startsWith(prefix)
                );
                console.log('‚úÖ Listado:', keys.length, 'claves');
                return { keys, prefix, shared };
            } catch (error) {
                console.error('‚ùå Error en list:', error);
                throw error;
            }
        }
    };
    
    const state = {
        coins: 0,
        hints: 0,
        currentStreak: 0,
        mode: null,
        questions: [],
        currentQIndex: -1,
        currentAnswer: [],
        usedLetters: [],
        timerInterval: null,
        timeLeft: TIME_LIMIT,
        timeLimit: TIME_LIMIT,
        playerId: null,
        playerName: 'Jugador',
        currentRoom: null,
        roomPollingInterval: null,
        multiplayerScore: 0,
        isHost: false,
        hasAnswered: false
    };

    const dom = {
        loadingScreen: document.getElementById('loading-screen'),
        mainContent: document.getElementById('main-content'),
        modeSelection: document.getElementById('mode-selection'),
        gameScreen: document.getElementById('game-screen'),
        shopScreen: document.getElementById('shop-screen'),
        multiplayerScreen: document.getElementById('multiplayer-screen'),
        currentModeDisplay: document.getElementById('current-mode'),
        coinsDisplay: document.getElementById('coins-display'),
        hintsDisplay: document.getElementById('hints-display'),
        streakDisplay: document.getElementById('streak-display'),
        questionText: document.getElementById('question-text'),
        questionValue: document.getElementById('question-value'),
        rachaTimer: document.getElementById('racha-timer'),
        hintButton: document.getElementById('hint-button'),
        aventuraContainer: document.getElementById('aventura-input-container'),
        answerSlots: document.getElementById('answer-slots'),
        letterButtons: document.getElementById('letter-buttons'),
        rachaContainer: document.getElementById('racha-input-container'),
        rachaAnswerInput: document.getElementById('racha-answer-input'),
        rachaFeedback: document.getElementById('racha-feedback'),
        modalContainer: document.getElementById('modal-container'),
        modalTitle: document.getElementById('modal-title'),
        modalText: document.getElementById('modal-text'),
        modalButtons: document.getElementById('modal-buttons'),
    };

    async function fetchSheetData(gid) {
        try {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`;
            const response = await fetch(url);
            const csv = await response.text();
            
            const lines = csv.trim().split('\n');
            const questions = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue;
                
                const parts = line.split(',');
                if (parts.length >= 4) {
                    const id = parts[0].trim();
                    const pregunta = parts[1].trim().replace(/^"|"$/g, '');
                    const respuesta = parts[2].trim().replace(/^"|"$/g, '').toUpperCase();
                    const valor = parseInt(parts[3].trim()) || 1;
                    
                    if (id && pregunta && respuesta) {
                        questions.push({
                            id: parseInt(id),
                            q: pregunta,
                            a: respuesta,
                            value: valor
                        });
                    }
                }
            }
            
            return questions;
        } catch (error) {
            console.error('Error cargando datos:', error);
            return [];
        }
    }

    async function loadQuestionsFromAPI() {
        try {
            document.getElementById('load-progress').style.width = '25%';
            rachaQuestions = await fetchSheetData(RACHA_GID);
            console.log('Racha cargadas:', rachaQuestions.length);
            
            document.getElementById('load-progress').style.width = '75%';
            adventureQuestions = await fetchSheetData(AVENTURA_GID);
            console.log('Aventura cargadas:', adventureQuestions.length);
            
            document.getElementById('load-progress').style.width = '100%';
            
            if (rachaQuestions.length > 0 && adventureQuestions.length > 0) {
                return true;
            } else {
                throw new Error('No se cargaron suficientes preguntas');
            }
        } catch (error) {
            console.error('‚ùå Error:', error);
            document.getElementById('loading-screen').innerHTML = `
                <p class="text-red-600 font-bold">Error al cargar preguntas</p>
                <p class="text-sm text-gray-600 mt-2">Revisa la consola (F12)</p>
                <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded">Reintentar</button>
            `;
            return false;
        }
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function generateRandomLetters(count) {
        const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        const letters = [];
        for (let i = 0; i < count; i++) {
            letters.push(alphabet.charAt(Math.floor(Math.random() * alphabet.length)));
        }
        return letters;
    }

    function normalizeAnswer(text) {
        if (!text) return "";
        let normalized = text.toUpperCase().trim();
        normalized = normalized.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        if (normalized.endsWith('S') && normalized.length > 1) {
            normalized = normalized.substring(0, normalized.length - 1);
        }
        return normalized;
    }

    function areAnswersClose(userAnswer, correctAnswer) {
        const userN = normalizeAnswer(userAnswer);
        const correctN = normalizeAnswer(correctAnswer);
        
        if (userN === correctN) return true;
        if (userAnswer.toUpperCase().trim() === correctAnswer.toUpperCase().trim()) return true;

        const userSingular = userAnswer.toUpperCase().trim().replace(/S$/, '');
        const correctSingular = correctAnswer.toUpperCase().trim().replace(/S$/, '');
        
        if (userSingular === correctAnswer.toUpperCase().trim() || correctSingular === userAnswer.toUpperCase().trim()) {
            return true;
        }
        
        return false;
    }

    function updateCoinsDisplay() { 
        dom.coinsDisplay.textContent = state.coins; 
        const playerDisplay = document.getElementById('player-coins-display');
        if (playerDisplay) playerDisplay.textContent = state.coins;
        const menuDisplay = document.getElementById('menu-coins-display');
        if (menuDisplay) menuDisplay.textContent = state.coins;
    }
    
    function updateHintsDisplay() { 
        dom.hintsDisplay.textContent = state.hints;
        const menuDisplay = document.getElementById('menu-hints-display');
        if (menuDisplay) menuDisplay.textContent = state.hints;
    }
    function updateStreakDisplay() { dom.streakDisplay.textContent = state.currentStreak; }

    function showTemporaryFeedback(element, message, colorClass) {
        element.textContent = message;
        element.classList.remove('hidden', 'text-indigo-500', 'text-red-500', 'text-green-500');
        element.classList.add(colorClass);
        setTimeout(() => element.classList.add('hidden'), 2000);
    }

    function resetView() {
        dom.modeSelection.classList.add('hidden');
        dom.gameScreen.classList.add('hidden');
        dom.shopScreen.classList.add('hidden');
        dom.multiplayerScreen.classList.add('hidden');
        dom.modalContainer.classList.add('hidden');
        
        document.getElementById('multiplayer-lobby').classList.add('hidden');
        document.getElementById('create-room-screen').classList.add('hidden');
        document.getElementById('join-room-screen').classList.add('hidden');
        document.getElementById('room-waiting-screen').classList.add('hidden');
        document.getElementById('leaderboard-screen').classList.add('hidden');
        document.getElementById('multiplayer-game-screen').classList.add('hidden');
    }

    function showModeSelection() {
        stopTimer();
        stopRoomPolling();
        state.mode = null;
        state.currentQIndex = -1;
        state.currentAnswer = [];
        state.usedLetters = [];
        state.currentStreak = 0;
        state.currentRoom = null;
        state.isHost = false;
        state.multiplayerScore = 0;
        state.hasAnswered = false;
        resetView();
        dom.modeSelection.classList.remove('hidden');
        dom.currentModeDisplay.textContent = 'N/A';
        updateCoinsDisplay();
    }

    function startGame(mode) {
        state.mode = mode;
        dom.currentModeDisplay.textContent = mode;
        
        if (mode === 'Racha') {
            state.questions = [...rachaQuestions];
            shuffleArray(state.questions);
            state.currentStreak = 0;
            document.getElementById('score-display-racha').classList.remove('hidden');
            document.getElementById('score-display-aventura').classList.add('hidden');
        } else if (mode === 'Aventura') {
            state.questions = [...adventureQuestions];
            shuffleArray(state.questions);
            document.getElementById('score-display-racha').classList.add('hidden');
            document.getElementById('score-display-aventura').classList.remove('hidden');
        }

        state.currentQIndex = -1;
        resetView();
        dom.gameScreen.classList.remove('hidden');
        goToNextQuestion();
    }

    function goToNextQuestion() {
        state.currentQIndex++;
        dom.modalContainer.classList.add('hidden');

        if (state.currentQIndex < state.questions.length) {
            loadQuestion(state.questions[state.currentQIndex]);
        } else {
            endGame();
        }
    }

    function startTimer() {
        stopTimer();
        state.timeLeft = state.timeLimit;
        dom.rachaTimer.textContent = `Tiempo: ${state.timeLeft}s`;
        dom.rachaTimer.classList.remove('bg-red-500', 'text-white', 'hidden');
        dom.rachaTimer.classList.add('bg-red-100', 'text-red-600');
        
        state.timerInterval = setInterval(() => {
            state.timeLeft--;
            dom.rachaTimer.textContent = `Tiempo: ${state.timeLeft}s`;

            if (state.timeLeft <= 5) {
                dom.rachaTimer.classList.remove('bg-red-100', 'text-red-600');
                dom.rachaTimer.classList.add('bg-red-500', 'text-white');
            }

            if (state.timeLeft <= 0) {
                handleTimeOut();
            }
        }, 1000);
    }

    function stopTimer() {
        if (state.timerInterval) {
            clearInterval(state.timerInterval);
            state.timerInterval = null;
        }
    }

    function handleTimeOut() {
        stopTimer();
        dom.rachaAnswerInput.disabled = true;
        document.getElementById('racha-check-button').disabled = true;
        endGame(false, "¬°Tiempo agotado!");
    }

    function handleRachaKeyPress(event) {
        if (event.key === 'Enter' && !document.getElementById('racha-check-button').disabled) {
            checkAnswer();
        }
    }

    function loadQuestion(question) {
        dom.rachaFeedback.classList.add('hidden');
        dom.rachaAnswerInput.value = '';
        dom.rachaAnswerInput.disabled = false;
        const checkButton = document.getElementById('racha-check-button');
        if (checkButton) checkButton.disabled = false;
        
        dom.questionText.textContent = question.q;
        
        const isAventura = state.mode === 'Aventura';
        
        dom.rachaContainer.classList.toggle('hidden', isAventura);
        dom.aventuraContainer.classList.toggle('hidden', !isAventura);
        dom.hintButton.classList.toggle('hidden', !isAventura);
        dom.rachaTimer.classList.add('hidden');

        if (isAventura) {
            dom.questionValue.textContent = `Valor: ${question.value} monedas`;
            state.currentAnswer = [];
            state.usedLetters = [];
            
            dom.answerSlots.innerHTML = '';
            const answerLength = question.a.length;
            for (let i = 0; i < answerLength; i++) {
                const slot = document.createElement('div');
                slot.classList.add('slot-box', 'bg-white', 'text-gray-800');
                slot.dataset.index = i;
                slot.textContent = '';
                dom.answerSlots.appendChild(slot);
            }
            generateLetterButtons(question.a);
        } else if (state.mode === 'Racha') {
            dom.questionValue.textContent = `Acierto #${state.currentQIndex + 1}`;
            dom.rachaTimer.classList.remove('hidden');
            startTimer();
        }
    }

    function checkAnswer() {
        if (!state.questions || state.currentQIndex < 0 || state.currentQIndex >= state.questions.length) return;

        const currentQ = state.questions[state.currentQIndex];
        let userAnswer = '';
        
        if (state.mode === 'Aventura') {
            userAnswer = state.currentAnswer.map(item => item.letter).join('');
            if (userAnswer.length !== currentQ.a.length) {
                showTemporaryFeedback(dom.rachaFeedback, 'Por favor, completa todas las casillas.', 'text-red-500');
                return;
            }
        } else {
            userAnswer = dom.rachaAnswerInput.value.toUpperCase().trim();
        }

        const isCorrect = areAnswersClose(userAnswer, currentQ.a);

        if (state.mode === 'Racha') {
            if (isCorrect) {
                handleRachaCorrect();
            } else {
                handleRachaIncorrect(currentQ.a);
            }
        } else if (state.mode === 'Aventura') {
            if (userAnswer === currentQ.a) { 
                handleAventuraCorrect(currentQ);
            } else {
                handleAventuraIncorrect();
            }
        }
    }

    function handleRachaCorrect() {
        stopTimer();
        state.currentStreak++;
        updateStreakDisplay();
        
        dom.rachaFeedback.textContent = '¬°Correcto! Racha: ' + state.currentStreak;
        dom.rachaFeedback.classList.remove('hidden', 'text-red-500');
        dom.rachaFeedback.classList.add('text-green-500');

        setTimeout(goToNextQuestion, 1000);
    }

    function handleRachaIncorrect(correctAnswer) {
        stopTimer();
        dom.rachaAnswerInput.disabled = true;
        document.getElementById('racha-check-button').disabled = true;
        dom.rachaFeedback.textContent = `¬°Incorrecto! La respuesta era: ${correctAnswer}`;
        dom.rachaFeedback.classList.remove('hidden', 'text-green-500');
        dom.rachaFeedback.classList.add('text-red-500');

        endGame(false, "¬°Racha Rota!");
    }

    function handleAventuraCorrect(currentQ) {
        const reward = currentQ.value;
        state.coins += reward;
        updateCoinsDisplay();
        savePlayerData();

        dom.modalTitle.textContent = "¬°Respuesta Correcta!";
        dom.modalTitle.classList.remove('text-red-600', 'text-indigo-600');
        dom.modalTitle.classList.add('text-green-600');
        dom.modalText.innerHTML = `¬°Ganaste <span class="text-green-600 font-bold">${reward} monedas</span>! Total: ${state.coins} monedas.`;

        dom.modalButtons.innerHTML = `
            <button onclick="goToNextQuestion()" class="w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-xl transition shadow-lg">
                Continuar
            </button>
            <button onclick="showModeSelection()" class="w-full py-3 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold rounded-xl transition">
                Abandonar
            </button>
        `;
        dom.modalContainer.classList.remove('hidden');
    }

    function handleAventuraIncorrect() {
        const slots = dom.answerSlots.children;
        Array.from(slots).forEach(slot => {
            slot.classList.add('incorrect');
        });

        state.currentAnswer = [];
        state.usedLetters = [];
        Array.from(dom.letterButtons.children).forEach(button => {
            button.disabled = false;
            button.classList.remove('bg-gray-300', 'opacity-50', 'cursor-not-allowed');
            button.classList.add('bg-white', 'hover:bg-gray-100');
        });
        Array.from(slots).forEach(slot => {
            slot.textContent = '';
        });
        
        showTemporaryFeedback(dom.rachaFeedback, 'Incorrecto. Intenta nuevamente.', 'text-red-500');
    }

    function endGame(completed = true, message = null) {
        stopTimer();
        savePlayerData();
        dom.modalContainer.classList.remove('hidden');
        
        if (state.mode === 'Racha') {
            dom.modalTitle.textContent = message || (completed ? "¬°Racha Completada!" : "¬°Racha Rota!");
            dom.modalTitle.classList.remove('text-green-600');
            dom.modalTitle.classList.add(completed ? 'text-indigo-600' : 'text-red-600');
            dom.modalText.innerHTML = `Tu racha final fue de <span class="text-xl font-bold">${state.currentStreak}</span> aciertos.`;
        } else if (state.mode === 'Aventura') {
            dom.modalTitle.textContent = "¬°Partida Finalizada!";
            dom.modalTitle.classList.remove('text-red-600');
            dom.modalTitle.classList.add('text-indigo-600');
            dom.modalText.innerHTML = `¬°Completaste el modo ${state.mode}! Total: <span class="text-indigo-600 font-bold">${state.coins} monedas</span>.`;
        }
        
        dom.modalButtons.innerHTML = `
            <button onclick="showModeSelection()" class="w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-xl transition shadow-lg">
                Volver a Modos
            </button>
        `;
    }

    function generateLetterButtons(correctAnswer) {
        const correctLetters = correctAnswer.split('');
        const requiredCount = correctLetters.length;
        const totalLetters = Math.max(requiredCount, 10);
        const fillerCount = totalLetters - requiredCount;

        let letterPool = [...correctLetters];
        letterPool = letterPool.concat(generateRandomLetters(fillerCount));
        shuffleArray(letterPool);

        dom.letterButtons.innerHTML = '';
        letterPool.forEach((letter, index) => {
            const button = document.createElement('button');
            button.textContent = letter;
            button.classList.add('letter-button', 'bg-white', 'text-lg', 'font-bold', 'py-2', 'px-3', 'rounded-lg', 'shadow-md', 'border', 'border-gray-200', 'hover:bg-gray-100');
            button.dataset.index = index;
            button.onclick = () => handleLetterClick(letter, index, button);
            dom.letterButtons.appendChild(button);
        });
    }

    function handleLetterClick(letter, index, button) {
        const slots = dom.answerSlots.children;
        const slotIndex = state.currentAnswer.length;

        if (slotIndex < slots.length) {
            slots[slotIndex].textContent = letter;
            slots[slotIndex].classList.add('filled');

            state.currentAnswer.push({ letter, buttonIndex: index });
            state.usedLetters.push(index);

            button.disabled = true;
            button.classList.remove('bg-white', 'hover:bg-gray-100');
            button.classList.add('bg-gray-300', 'opacity-50', 'cursor-not-allowed');
        }
        Array.from(slots).forEach(slot => slot.classList.remove('incorrect'));
    }

    function undoLastLetter() {
        if (state.currentAnswer.length === 0) return;

        state.currentAnswer.pop();
        
        const slots = dom.answerSlots.children;
        const lastSlot = slots[state.currentAnswer.length];
        if (lastSlot) {
            lastSlot.textContent = '';
            lastSlot.classList.remove('filled', 'incorrect');
        }

        const lastUsedButtonIndex = state.usedLetters.pop();
        const buttonToEnable = document.querySelector(`.letter-button[data-index="${lastUsedButtonIndex}"]`);
        
        if (buttonToEnable) {
            buttonToEnable.disabled = false;
            buttonToEnable.classList.remove('bg-gray-300', 'opacity-50', 'cursor-not-allowed');
            buttonToEnable.classList.add('bg-white', 'hover:bg-gray-100');
        }
    }

    function showHint() {
        if (state.hints <= 0) {
            showTemporaryFeedback(dom.rachaFeedback, '¬°No tienes pistas! C√≥mpralas en la tienda.', 'text-red-500');
            return;
        }

        const currentQ = state.questions[state.currentQIndex];
        const correctLetter = currentQ.a.charAt(0);
        
        if (state.currentAnswer.length === 0) {
            const letterPoolButtons = Array.from(dom.letterButtons.children);
            const targetButton = letterPoolButtons.find(btn => btn.textContent === correctLetter && !btn.disabled);

            if (targetButton) {
                handleLetterClick(correctLetter, parseInt(targetButton.dataset.index), targetButton);
                state.hints--;
                updateHintsDisplay();
                savePlayerData();
                showTemporaryFeedback(dom.rachaFeedback, '¬°Pista usada! Te quedan ' + state.hints, 'text-indigo-500');
            }
        }
    }

    function showShop() {
        resetView();
        dom.shopScreen.classList.remove('hidden');
        document.getElementById('time-limit-display').textContent = state.timeLimit + 's';
        checkAdCooldown();
    }

    function buyHints(amount) {
        const prices = { 1: 50, 5: 200, 10: 350 };
        const cost = prices[amount];
        
        if (state.coins >= cost) {
            state.coins -= cost;
            state.hints += amount;
            updateCoinsDisplay();
            updateHintsDisplay();
            savePlayerData();
            
            dom.modalTitle.textContent = "¬°Compra Exitosa!";
            dom.modalTitle.classList.remove('text-red-600');
            dom.modalTitle.classList.add('text-green-600');
            dom.modalText.innerHTML = `Compraste ${amount} pista${amount > 1 ? 's' : ''} por ${cost} üí∞`;
            dom.modalButtons.innerHTML = `
                <button onclick="dom.modalContainer.classList.add('hidden')" class="w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-xl transition">
                    Continuar
                </button>
            `;
            dom.modalContainer.classList.remove('hidden');
        } else {
            dom.modalTitle.textContent = "Monedas Insuficientes";
            dom.modalTitle.classList.remove('text-green-600');
            dom.modalTitle.classList.add('text-red-600');
            dom.modalText.innerHTML = `Necesitas ${cost} üí∞ pero solo tienes ${state.coins} üí∞`;
            dom.modalButtons.innerHTML = `
                <button onclick="dom.modalContainer.classList.add('hidden')" class="w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-xl transition">
                    Entendido
                </button>
            `;
            dom.modalContainer.classList.remove('hidden');
        }
    }

    function buyTime(seconds) {
        const prices = { 5: 100, 10: 150 };
        const cost = prices[seconds];
        
        if (state.timeLimit + seconds > MAX_TIME_LIMIT) {
            dom.modalTitle.textContent = "L√≠mite Alcanzado";
            dom.modalTitle.classList.remove('text-green-600');
            dom.modalTitle.classList.add('text-yellow-600');
            dom.modalText.innerHTML = `El tiempo m√°ximo permitido es ${MAX_TIME_LIMIT} segundos`;
            dom.modalButtons.innerHTML = `
                <button onclick="dom.modalContainer.classList.add('hidden')" class="w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-xl transition">
                    Entendido
                </button>
            `;
            dom.modalContainer.classList.remove('hidden');
            return;
        }
        
        if (state.coins >= cost) {
            state.coins -= cost;
            state.timeLimit += seconds;
            updateCoinsDisplay();
            savePlayerData();
            document.getElementById('time-limit-display').textContent = state.timeLimit + 's';
            
            dom.modalTitle.textContent = "¬°Compra Exitosa!";
            dom.modalTitle.classList.remove('text-red-600');
            dom.modalTitle.classList.add('text-green-600');
            dom.modalText.innerHTML = `Compraste +${seconds} segundos. Nuevo l√≠mite: ${state.timeLimit}s`;
            dom.modalButtons.innerHTML = `
                <button onclick="dom.modalContainer.classList.add('hidden')" class="w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-xl transition">
                    Continuar
                </button>
            `;
            dom.modalContainer.classList.remove('hidden');
        } else {
            dom.modalTitle.textContent = "Monedas Insuficientes";
            dom.modalTitle.classList.remove('text-green-600');
            dom.modalTitle.classList.add('text-red-600');
            dom.modalText.innerHTML = `Necesitas ${cost} üí∞ pero solo tienes ${state.coins} üí∞`;
            dom.modalButtons.innerHTML = `
                <button onclick="dom.modalContainer.classList.add('hidden')" class="w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-xl transition">
                    Entendido
                </button>
            `;
            dom.modalContainer.classList.remove('hidden');
        }
    }

    async function watchAd() {
        const lastAdTime = localStorage.getItem('lastAdTime');
        const now = Date.now();
        const cooldown = 5 * 60 * 1000;

        if (lastAdTime && (now - parseInt(lastAdTime)) < cooldown) {
            const remaining = Math.ceil((cooldown - (now - parseInt(lastAdTime))) / 1000 / 60);
            dom.modalTitle.textContent = "Espera un momento";
            dom.modalTitle.classList.remove('text-green-600');
            dom.modalTitle.classList.add('text-yellow-600');
            dom.modalText.innerHTML = `Podr√°s ver otro anuncio en ${remaining} minuto${remaining > 1 ? 's' : ''}`;
            dom.modalButtons.innerHTML = `
                <button onclick="dom.modalContainer.classList.add('hidden')" class="w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-xl transition">
                    Entendido
                </button>
            `;
            dom.modalContainer.classList.remove('hidden');
            return;
        }

        dom.modalTitle.textContent = "üì∫ Viendo Anuncio...";
        dom.modalTitle.classList.remove('text-red-600', 'text-yellow-600');
        dom.modalTitle.classList.add('text-indigo-600');
        dom.modalText.innerHTML = `
            <div class="text-center">
                <div class="animate-pulse text-4xl mb-3">üì∫</div>
                <p>Espera 5 segundos...</p>
                <div class="w-full bg-gray-200 rounded-full h-2 mt-3">
                    <div id="ad-progress" class="bg-green-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                </div>
            </div>
        `;
        dom.modalButtons.innerHTML = '';
        dom.modalContainer.classList.remove('hidden');

        let progress = 0;
        const adInterval = setInterval(() => {
            progress += 20;
            const progressBar = document.getElementById('ad-progress');
            if (progressBar) progressBar.style.width = progress + '%';
            
            if (progress >= 100) {
                clearInterval(adInterval);
                completeAd();
            }
        }, 1000);
    }

    function completeAd() {
        state.coins += 30;
        updateCoinsDisplay();
        savePlayerData();
        localStorage.setItem('lastAdTime', Date.now().toString());
        
        dom.modalTitle.textContent = "¬°Recompensa Recibida!";
        dom.modalTitle.classList.add('text-green-600');
        dom.modalText.innerHTML = `¬°Ganaste 30 üí∞! Total: ${state.coins} üí∞`;
        dom.modalButtons.innerHTML = `
            <button onclick="dom.modalContainer.classList.add('hidden'); checkAdCooldown();" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-xl transition">
                ¬°Genial!
            </button>
        `;
    }

    function checkAdCooldown() {
        const lastAdTime = localStorage.getItem('lastAdTime');
        const now = Date.now();
        const cooldown = 5 * 60 * 1000;
        const adBtn = document.getElementById('watch-ad-btn');
        const adCooldown = document.getElementById('ad-cooldown');

        if (lastAdTime && (now - parseInt(lastAdTime)) < cooldown) {
            const remaining = Math.ceil((cooldown - (now - parseInt(lastAdTime))) / 1000 / 60);
            adBtn.disabled = true;
            adBtn.classList.add('opacity-50', 'cursor-not-allowed');
            adCooldown.textContent = `Disponible en ${remaining} minuto${remaining > 1 ? 's' : ''}`;
            adCooldown.classList.remove('hidden');
        } else {
            adBtn.disabled = false;
            adBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            adCooldown.classList.add('hidden');
        }
    }

    // FUNCIONES MULTIJUGADOR
    function showMultiplayer() {
        resetView();
        dom.multiplayerScreen.classList.remove('hidden');
        document.getElementById('multiplayer-lobby').classList.remove('hidden');
    }

    function backToMultiplayerLobby() {
        stopRoomPolling();
        state.currentRoom = null;
        state.isHost = false;
        resetView();
        dom.multiplayerScreen.classList.remove('hidden');
        document.getElementById('multiplayer-lobby').classList.remove('hidden');
    }

    function showCreateRoom() {
        resetView();
        dom.multiplayerScreen.classList.remove('hidden');
        document.getElementById('create-room-screen').classList.remove('hidden');
        document.getElementById('create-player-name').value = state.playerName;
    }

    function showJoinRoom() {
        resetView();
        dom.multiplayerScreen.classList.remove('hidden');
        document.getElementById('join-room-screen').classList.remove('hidden');
        document.getElementById('join-player-name').value = state.playerName;
        loadAvailableRooms();
    }

    function showLeaderboard() {
        resetView();
        dom.multiplayerScreen.classList.remove('hidden');
        document.getElementById('leaderboard-screen').classList.remove('hidden');
        document.getElementById('player-name-display').textContent = state.playerName;
        loadLeaderboard();
    }

    function generateRoomCode() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let code = '';
        for (let i = 0; i < 6; i++) {
            code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return code;
    }

    async function createRoom() {
        const playerName = document.getElementById('create-player-name').value.trim();
        const rounds = parseInt(document.getElementById('room-rounds').value);
        const maxPlayers = parseInt(document.getElementById('room-max-players').value);

        if (!playerName) {
            alert('Por favor ingresa tu nombre');
            return;
        }

        if (rounds < 5 || rounds > 20) {
            alert('Las rondas deben estar entre 5 y 20');
            return;
        }

        if (maxPlayers < 2 || maxPlayers > 10) {
            alert('Los jugadores deben estar entre 2 y 10');
            return;
        }

        if (!database) {
            alert('‚ùå Error: No hay conexi√≥n con Firebase.\n\nPor favor:\n1. Verifica tu conexi√≥n a internet\n2. Revisa la consola (F12) para m√°s detalles\n3. Recarga la p√°gina');
            return;
        }

        state.playerName = playerName;
        const roomCode = generateRoomCode();
    
        const roomData = {
            code: roomCode,
            host: state.playerId,
            rounds: rounds,
            maxPlayers: maxPlayers,
            players: [{
                id: state.playerId,
                name: playerName,
                score: 0,
                ready: false
            }],
            currentRound: 0,
            status: 'waiting',
            questions: [],
            created: Date.now()
        };

        try {
            const btn = document.querySelector('#create-room-screen button');
            btn.disabled = true;
            btn.textContent = 'Creando sala...';
        
            // Usar Firebase directamente
            await database.ref('shared/room:' + roomCode).set(roomData);
        
            console.log('‚úÖ Sala creada exitosamente:', roomCode);
        
            state.currentRoom = roomCode;
            state.isHost = true;
            joinWaitingRoom(roomData);
        } catch (error) {
            console.error('‚ùå Error creando sala:', error);
            alert('Error al crear la sala:\n' + error.message + '\n\nRevisa la consola (F12) para m√°s detalles.');
        
            const btn = document.querySelector('#create-room-screen button');
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'Crear Sala';
            }
        }
    }
    
    async function joinRoom() {
        const playerName = document.getElementById('join-player-name').value.trim();
        const roomCode = document.getElementById('room-code-input').value.trim().toUpperCase();

        if (!playerName) {
            alert('Por favor ingresa tu nombre');
            return;
        }

        if (!roomCode) {
            alert('Por favor ingresa un c√≥digo de sala');
            return;
        }

        state.playerName = playerName;

        try {
            const result = await window.storage.get('room:' + roomCode, true);
            if (!result) {
                alert('Sala no encontrada');
                return;
            }

            // ‚úÖ CAMBIO: Eliminar JSON.parse
            const roomData = result.value;

            if (roomData.players.length >= roomData.maxPlayers) {
                alert('La sala est√° llena');
                return;
            }

            if (roomData.status !== 'waiting') {
                alert('La partida ya comenz√≥');
                return;
            }

            const existingPlayer = roomData.players.find(p => p.id === state.playerId);
            if (!existingPlayer) {
                roomData.players.push({
                    id: state.playerId,
                    name: playerName,
                    score: 0,
                    ready: false
                });

                // ‚úÖ CAMBIO: No hacer JSON.stringify
                await window.storage.set('room:' + roomCode, roomData, true);
            }

            state.currentRoom = roomCode;
            state.isHost = false;
            joinWaitingRoom(roomData);
        } catch (error) {
            console.error('Error uni√©ndose a sala:', error);
            alert('Error al unirse a la sala');
        }
    }
    
    function joinWaitingRoom(roomData) {
        resetView();
        dom.multiplayerScreen.classList.remove('hidden');
        document.getElementById('room-waiting-screen').classList.remove('hidden');
        
        document.getElementById('room-code-display').textContent = roomData.code;
        document.getElementById('room-rounds-display').textContent = roomData.rounds;
        document.getElementById('room-max-players-display').textContent = roomData.maxPlayers;
        
        updateRoomPlayersList(roomData);
        
        if (state.isHost) {
            document.getElementById('start-multiplayer-btn').classList.remove('hidden');
        } else {
            document.getElementById('start-multiplayer-btn').classList.add('hidden');
        }
        
        startRoomPolling();
    }

    function updateRoomPlayersList(roomData) {
        const list = document.getElementById('room-players-list');
        const count = document.getElementById('room-players-count');
        
        count.textContent = roomData.players.length;
        
        list.innerHTML = roomData.players.map(player => `
            <div class="flex items-center justify-between p-2 bg-white rounded-lg">
                <span class="font-medium">${player.name}</span>
                ${player.id === roomData.host ? '<span class="text-xs bg-pink-500 text-white px-2 py-1 rounded">Anfitri√≥n</span>' : ''}
            </div>
        `).join('');
    }

    function startRoomPolling() {
        stopRoomPolling();
    
        state.roomPollingInterval = setInterval(async () => {
            if (!state.currentRoom) {
                stopRoomPolling();
                return;
            }

            try {
                const result = await window.storage.get('room:' + state.currentRoom, true);
                if (!result) {
                    stopRoomPolling();
                    alert('La sala fue cerrada');
                    backToMultiplayerLobby();
                    return;
                }

                // ‚úÖ CAMBIO: Eliminar JSON.parse
                const roomData = result.value;
            
                if (roomData.status === 'playing') {
                    stopRoomPolling();
                    startMultiplayerGameSession(roomData);
                } else {
                    updateRoomPlayersList(roomData);
                }
            } catch (error) {
                console.error('Error actualizando sala:', error);
            }
        }, 2000);
    }

    function stopRoomPolling() {
        if (state.roomPollingInterval) {
            clearInterval(state.roomPollingInterval);
            state.roomPollingInterval = null;
        }
    }

    async function leaveRoom() {
        if (!state.currentRoom) return;

        try {
            const result = await window.storage.get('room:' + state.currentRoom, true);
            if (result) {
                // ‚úÖ CAMBIO: Eliminar JSON.parse
                const roomData = result.value;
                roomData.players = roomData.players.filter(p => p.id !== state.playerId);

                if (roomData.players.length === 0 || state.isHost) {
                    await window.storage.delete('room:' + state.currentRoom, true);
                } else {
                    if (state.isHost && roomData.players.length > 0) {
                        roomData.host = roomData.players[0].id;
                    }
                    // ‚úÖ CAMBIO: No hacer JSON.stringify
                    await window.storage.set('room:' + state.currentRoom, roomData, true);
                }
            }
        } catch (error) {
            console.error('Error saliendo de sala:', error);
        }

        stopRoomPolling();
        backToMultiplayerLobby();
    }

    async function startMultiplayerGame() {
        if (!state.isHost || !state.currentRoom) return;

        try {
            const result = await window.storage.get('room:' + state.currentRoom, true);
            if (!result) return;

            // ‚úÖ CAMBIO: Eliminar JSON.parse
            const roomData = result.value;

            if (roomData.players.length < 2) {
                alert('Se necesitan al menos 2 jugadores para comenzar');
                return;
            }

            const questions = [...rachaQuestions];
            shuffleArray(questions);
            roomData.questions = questions.slice(0, roomData.rounds);
            roomData.status = 'playing';
            roomData.currentRound = 0;

            // ‚úÖ CAMBIO: No hacer JSON.stringify
            await window.storage.set('room:' + state.currentRoom, roomData, true);
        } catch (error) {
            console.error('Error iniciando partida:', error);
            alert('Error al iniciar la partida');
        }
    }

    function startMultiplayerGameSession(roomData) {
        state.multiplayerScore = 0;
        state.hasAnswered = false;
        
        resetView();
        dom.multiplayerScreen.classList.remove('hidden');
        document.getElementById('multiplayer-game-screen').classList.remove('hidden');
        
        document.getElementById('mp-total-rounds').textContent = roomData.rounds;
        document.getElementById('mp-total-players').textContent = roomData.players.length;
        
        loadMultiplayerQuestion(roomData);
        startMultiplayerPolling();
    }

    function loadMultiplayerQuestion(roomData) {
        state.hasAnswered = false;
        const currentQ = roomData.questions[roomData.currentRound];
        
        document.getElementById('mp-round-display').textContent = roomData.currentRound + 1;
        document.getElementById('mp-score-display').textContent = state.multiplayerScore;
        document.getElementById('mp-question-text').textContent = currentQ.q;
        document.getElementById('mp-answer-input').value = '';
        document.getElementById('mp-answer-input').disabled = false;
        document.getElementById('mp-check-button').disabled = false;
        document.getElementById('mp-feedback').classList.add('hidden');
        document.getElementById('mp-waiting').classList.add('hidden');
        document.getElementById('mp-scoreboard').classList.add('hidden');
        
        startMultiplayerTimer();
    }

    function startMultiplayerTimer() {
        stopTimer();
        state.timeLeft = MP_TIME_LIMIT;
        const timerEl = document.getElementById('mp-timer');
        timerEl.textContent = `Tiempo: ${state.timeLeft}s`;
        timerEl.classList.remove('bg-red-500', 'text-white');
        timerEl.classList.add('bg-red-100', 'text-red-600');
        
        state.timerInterval = setInterval(() => {
            state.timeLeft--;
            timerEl.textContent = `Tiempo: ${state.timeLeft}s`;

            if (state.timeLeft <= 5) {
                timerEl.classList.remove('bg-red-100', 'text-red-600');
                timerEl.classList.add('bg-red-500', 'text-white');
            }

            if (state.timeLeft <= 0) {
                handleMultiplayerTimeout();
            }
        }, 1000);
    }

    function handleMultiplayerKeyPress(event) {
        if (event.key === 'Enter' && !document.getElementById('mp-check-button').disabled) {
            submitMultiplayerAnswer();
        }
    }

    async function submitMultiplayerAnswer() {
        if (state.hasAnswered) return;

        stopTimer();
        state.hasAnswered = true;

        try {
            const result = await window.storage.get('room:' + state.currentRoom, true);
            if (!result) return;

            // ‚úÖ CAMBIO: Eliminar JSON.parse
            const roomData = result.value;
            const currentQ = roomData.questions[roomData.currentRound];
            const userAnswer = document.getElementById('mp-answer-input').value.toUpperCase().trim();
            const isCorrect = areAnswersClose(userAnswer, currentQ.a);

            const pointsEarned = isCorrect ? Math.max(1, Math.floor(10 * (state.timeLeft / MP_TIME_LIMIT))) : 0;
            state.multiplayerScore += pointsEarned;

            const playerIndex = roomData.players.findIndex(p => p.id === state.playerId);
            if (playerIndex !== -1) {
                roomData.players[playerIndex].score = state.multiplayerScore;
                roomData.players[playerIndex].answered = true;
            }

            // ‚úÖ CAMBIO: No hacer JSON.stringify
            await window.storage.set('room:' + state.currentRoom, roomData, true);

            document.getElementById('mp-answer-input').disabled = true;
            document.getElementById('mp-check-button').disabled = true;

            const feedbackEl = document.getElementById('mp-feedback');
            feedbackEl.textContent = isCorrect ? `¬°Correcto! +${pointsEarned} puntos` : `Incorrecto. Respuesta: ${currentQ.a}`;
            feedbackEl.classList.remove('hidden', 'text-red-500', 'text-green-500');
            feedbackEl.classList.add(isCorrect ? 'text-green-500' : 'text-red-500');

            document.getElementById('mp-waiting').classList.remove('hidden');
            updateMultiplayerWaitingCount(roomData);
        } catch (error) {
            console.error('Error enviando respuesta:', error);
        }
    }
    
    async function handleMultiplayerTimeout() {
        if (state.hasAnswered) return;
    
            stopTimer();
        state.hasAnswered = true;

        try {
            const result = await window.storage.get('room:' + state.currentRoom, true);
            if (!result) return;

            // ‚úÖ CAMBIO: Eliminar JSON.parse
            const roomData = result.value;
            const currentQ = roomData.questions[roomData.currentRound];

            const playerIndex = roomData.players.findIndex(p => p.id === state.playerId);
            if (playerIndex !== -1) {
                roomData.players[playerIndex].answered = true;
            }

            // ‚úÖ CAMBIO: No hacer JSON.stringify
            await window.storage.set('room:' + state.currentRoom, roomData, true);

            document.getElementById('mp-answer-input').disabled = true;
            document.getElementById('mp-check-button').disabled = true;

            const feedbackEl = document.getElementById('mp-feedback');
            feedbackEl.textContent = `Tiempo agotado. Respuesta: ${currentQ.a}`;
            feedbackEl.classList.remove('hidden', 'text-green-500');
            feedbackEl.classList.add('text-red-500');

            document.getElementById('mp-waiting').classList.remove('hidden');
            updateMultiplayerWaitingCount(roomData);
        } catch (error) {
            console.error('Error en timeout:', error);
        }
    }

    function updateMultiplayerWaitingCount(roomData) {
        const answeredCount = roomData.players.filter(p => p.answered).length;
        document.getElementById('mp-answered-count').textContent = answeredCount;
    }

    function startMultiplayerPolling() {
        stopRoomPolling();
    
        state.roomPollingInterval = setInterval(async () => {
            if (!state.currentRoom) {
                stopRoomPolling();
                return;
            }

            try {
                const result = await window.storage.get('room:' + state.currentRoom, true);
                if (!result) {
                    stopRoomPolling();
                    alert('La sala fue cerrada');
                    showModeSelection();
                    return;
                }

                // ‚úÖ CAMBIO: Eliminar JSON.parse
                const roomData = result.value;
            
                if (state.hasAnswered) {
                    updateMultiplayerWaitingCount(roomData);
                
                    const allAnswered = roomData.players.every(p => p.answered);
                
                    if (allAnswered && state.isHost) {
                        roomData.players.forEach(p => p.answered = false);
                        roomData.currentRound++;
                        // ‚úÖ CAMBIO: No hacer JSON.stringify
                        await window.storage.set('room:' + state.currentRoom, roomData, true);
                    }
                }

                if (roomData.currentRound >= roomData.rounds) {
                    stopRoomPolling();
                    showMultiplayerResults(roomData);
                } else if (roomData.players.every(p => p.answered === false) && state.hasAnswered) {
                    loadMultiplayerQuestion(roomData);
                }
            } catch (error) {
                console.error('Error en polling multijugador:', error);
            }
        }, 1000);
    }
    
    function showMultiplayerResults(roomData) {
        stopTimer();
        stopRoomPolling();

        const sortedPlayers = [...roomData.players].sort((a, b) => b.score - a.score);
        const winner = sortedPlayers[0];

        dom.modalTitle.textContent = "¬°Partida Finalizada!";
        dom.modalTitle.classList.remove('text-red-600');
        dom.modalTitle.classList.add('text-pink-600');
        
        const isWinner = winner.id === state.playerId;
        
        dom.modalText.innerHTML = `
            <div class="space-y-3">
                <p class="text-2xl font-bold ${isWinner ? 'text-yellow-500' : 'text-gray-700'}">
                    ${isWinner ? 'üèÜ ¬°Ganaste!' : 'üéÆ Fin del Juego'}
                </p>
                <p class="text-lg">Ganador: <span class="font-bold text-pink-600">${winner.name}</span></p>
                <p>Tu puntuaci√≥n: <span class="font-bold">${state.multiplayerScore}</span></p>
                <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                    <p class="font-bold mb-2">Puntuaciones Finales:</p>
                    ${sortedPlayers.map((p, i) => `
                        <div class="flex justify-between items-center p-1">
                            <span>${i + 1}. ${p.name}</span>
                            <span class="font-bold">${p.score}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;

        dom.modalButtons.innerHTML = `
            <button onclick="cleanupRoomAndReturn()" class="w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-xl transition shadow-lg">
                Volver al Men√∫
            </button>
        `;
        dom.modalContainer.classList.remove('hidden');
    }

    async function cleanupRoomAndReturn() {
        if (state.currentRoom && state.isHost) {
            try {
                await window.storage.delete('room:' + state.currentRoom, true);
            } catch (error) {
                console.error('Error limpiando sala:', error);
            }
        }
        showModeSelection();
    }

    async function loadAvailableRooms() {
        const container = document.getElementById('available-rooms');
        container.innerHTML = '<p class="text-center text-gray-500">Cargando...</p>';
    
        try {
            const result = await window.storage.list('room:', true);
            if (!result || !result.keys || result.keys.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">No hay salas disponibles</p>';
                return;
            }

            const rooms = [];
            for (const key of result.keys) {
                try {
                    const roomResult = await window.storage.get(key, true);
                    if (roomResult && roomResult.value) {
                        // ‚úÖ CAMBIO: Eliminar JSON.parse
                        const room = roomResult.value;
                        if (room.status === 'waiting') {
                            rooms.push(room);
                        }
                    }
                } catch (e) {
                    console.error('Error loading room:', e);
                }
            }

            if (rooms.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">No hay salas disponibles</p>';
                return;
            }

            container.innerHTML = rooms.map(room => `
                <div class="flex justify-between items-center p-2 bg-white rounded-lg">
                    <div>
                        <p class="font-bold">${room.code}</p>
                        <p class="text-xs text-gray-600">${room.players.length}/${room.maxPlayers} jugadores ¬∑ ${room.rounds} rondas</p>
                    </div>
                    <button onclick="quickJoinRoom('${room.code}')" class="px-3 py-1 bg-purple-500 hover:bg-purple-600 text-white text-sm font-bold rounded transition">
                        Unirse
                    </button>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading rooms:', error);
            container.innerHTML = '<p class="text-center text-red-500">Error al cargar salas</p>';
        }
    }
    
    async function quickJoinRoom(roomCode) {
        document.getElementById('room-code-input').value = roomCode;
        await joinRoom();
    }

    async function loadLeaderboard() {
        const container = document.getElementById('leaderboard-container');
        container.innerHTML = '<p class="text-center text-gray-500">Cargando...</p>';
    
        try {
            const result = await window.storage.list('player:', true);
            if (!result || !result.keys || result.keys.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">No hay jugadores a√∫n</p>';
                return;
            }

            const players = [];
            for (const key of result.keys) {
                try {
                    const playerData = await window.storage.get(key, true);
                    if (playerData && playerData.value) {
                        // ‚úÖ CAMBIO: Eliminar JSON.parse
                        const data = playerData.value;
                        players.push(data);
                    }
                } catch (e) {
                    console.error('Error loading player:', e);
                }
            }

            players.sort((a, b) => (b.totalCoins || 0) - (a.totalCoins || 0));
        
            if (players.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">No hay jugadores a√∫n</p>';
                return;
            }

            container.innerHTML = players.slice(0, 10).map((player, index) => `
                <div class="flex justify-between items-center p-2 bg-white rounded-lg ${player.id === state.playerId ? 'border-2 border-pink-500' : ''}">
                    <span class="font-bold">${index + 1}. ${player.name || 'Jugador'}</span>
                    <span class="text-green-600 font-bold">${player.totalCoins || 0} üí∞</span>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading leaderboard:', error);
            container.innerHTML = '<p class="text-center text-red-500">Error al cargar clasificaci√≥n</p>';
        }
    }

    async function updatePlayerName() {
        const input = document.getElementById('player-name-input');
        const name = input.value.trim();
        
        if (!name) {
            alert('Por favor ingresa un nombre');
            return;
        }

        state.playerName = name;
        document.getElementById('player-name-display').textContent = name;
        await savePlayerData();
        input.value = '';
        
        dom.modalTitle.textContent = "¬°Nombre Actualizado!";
        dom.modalTitle.classList.remove('text-red-600');
        dom.modalTitle.classList.add('text-green-600');
        dom.modalText.innerHTML = `Tu nombre ahora es: <strong>${name}</strong>`;
        dom.modalButtons.innerHTML = `
            <button onclick="dom.modalContainer.classList.add('hidden')" class="w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-xl transition">
                Continuar
            </button>
        `;
        dom.modalContainer.classList.remove('hidden');
    }

    async function savePlayerData() {
        try {
            if (!state.playerId) {
                state.playerId = 'player_' + Math.random().toString(36).substr(2, 9);
            }

            const playerData = {
                id: state.playerId,
                name: state.playerName || 'Jugador',
                totalCoins: state.coins,
                hints: state.hints,
                timeLimit: state.timeLimit,
                lastUpdated: Date.now()
            };

            localStorage.setItem('playerId', state.playerId);
            localStorage.setItem('playerData', JSON.stringify({ 
                coins: state.coins, 
                hints: state.hints,             name: state.playerName,
                timeLimit: state.timeLimit
            }));

            if (database) {
                try {
                    // ‚úÖ CAMBIO: Usar window.storage en lugar de Firebase directamente
                    await window.storage.set('player:' + state.playerId, playerData, true);
                    console.log('‚úÖ Datos guardados en Firebase');
                } catch (fbError) {
                    console.log('‚ö†Ô∏è No se pudo guardar en Firebase, pero datos locales guardados');
                }
            }
        } catch (error) {
            console.error('Error saving player data:', error);
        }
    }

    async function loadPlayerData() {
        try {
            const savedId = localStorage.getItem('playerId');
            const savedData = localStorage.getItem('playerData');
        
            if (savedData) {
                const data = JSON.parse(savedData);
                state.coins = data.coins || 0;
                state.hints = data.hints || 0;
                state.playerName = data.name || 'Jugador';
                state.timeLimit = data.timeLimit || TIME_LIMIT;
            }

            if (savedId) {
                state.playerId = savedId;
            } else {
                state.playerId = 'player_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('playerId', state.playerId);
            }
        
            // ‚úÖ AGREGADO: Actualizar displays siempre
            updateCoinsDisplay();
            updateHintsDisplay();
            document.getElementById('player-name-display').textContent = state.playerName;
        } catch (error) {
            console.error('Error loading player data:', error);
        }
    }

    window.startGame = startGame;
    window.showModeSelection = showModeSelection;
    window.checkAnswer = checkAnswer;
    window.handleRachaKeyPress = handleRachaKeyPress;
    window.showHint = showHint;
    window.undoLastLetter = undoLastLetter;
    window.goToNextQuestion = goToNextQuestion;
    window.showShop = showShop;
    window.buyHints = buyHints;
    window.buyTime = buyTime;
    window.watchAd = watchAd;
    window.showMultiplayer = showMultiplayer;
    window.updatePlayerName = updatePlayerName;
    window.backToMultiplayerLobby = backToMultiplayerLobby;
    window.showCreateRoom = showCreateRoom;
    window.showJoinRoom = showJoinRoom;
    window.showLeaderboard = showLeaderboard;
    window.createRoom = createRoom;
    window.joinRoom = joinRoom;
    window.quickJoinRoom = quickJoinRoom;
    window.leaveRoom = leaveRoom;
    window.startMultiplayerGame = startMultiplayerGame;
    window.submitMultiplayerAnswer = submitMultiplayerAnswer;
    window.handleMultiplayerKeyPress = handleMultiplayerKeyPress;
    window.cleanupRoomAndReturn = cleanupRoomAndReturn;

    window.onload = async function() {
        const loaded = await loadQuestionsFromAPI();
        if (loaded) {
            await loadPlayerData();
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            showModeSelection();
        }
    };
</script>
</body>
</html>
